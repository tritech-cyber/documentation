define(["jquery","config","slateplus","myslate","s_code","templates","fbevents-amd","livefyre","libs/jquery-plugins/jquery.storageapi"],function(a,b,c,d,e,f,g){var h={settingsPage:a("#settings").size()&&"account"===window.commercialNode,isHomePage:"homepage"===window.commercialNode?1:0,isPitchPage:b.page.pitchPage,hasRoadblock:b.page.roadblocked,shownRoadblock:0,storage:a.initNamespaceStorage(b.janrain.siteConfig.jsNamespace),myslateAjax:null,delay:0,debugEnabled:JSON.parse(localStorage.janrainDebugEnabled),screenToRenderParam:null,config:b.janrain.siteConfig,isSecure:0,defaultScreens:["resetPasswordRequestCode"],myslateStatuses:["deactivated","declined"]},i=a(window),j=b.myslate.myslate_domain,k=b.myslate.myslate_https,l=(k?"https:":"http:")+j+"login/?screenToRender=editProfile",m=document.location.href+"";m=window.encodeURIComponent(m),h.init=function(){return this.debug("init"),this.initListeners(),this},h.initListeners=function(){this.debug("initListeners");var a=this,c={storage:function(b){["janrainCaptureToken"].indexOf(b.originalEvent.key)>-1&&(b.originalEvent.newValue?janrain.capture.ui.start():a.endSession())},message:function(c){var d=c.originalEvent;if(d.origin.indexOf(b.myslate.site_base_domain)>-1){var e=d.data,f=d.source;void 0!==e.janrain&&a.handleMySlateCommunication(e,f)}},"MySlateData.Fetch":function(b,c){a.handlePlusButton().handlePlusHomepagePromo().showSlatePlusEmail()}};mobileMode()&&i.one("janrain.mobileNavClick",function(b,c){a.mobileProfileHeader()}),i.on(c)},h.triggerEvents=function(a,b){return this.debug("triggerEvents",a,b),i.trigger(a,b),this},h.visible=function(){this.debug("visible");var a;return void 0!==document.hidden?a="hidden":void 0!==document.mozHidden?a="mozHidden":void 0!==document.msHidden?a="msHidden":void 0!==document.oHidden?a="oHidden":void 0!==document.webkitHidden&&(a="webkitHidden"),!document[a]},h.getParameterByName=function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=location.search.replace(/&amp;/g,"&"),c=new RegExp("[\\?&]"+a+"=([^&#]*)"),d=c.exec(b);return this.screenToRenderParam=null===d?"":decodeURIComponent(d[1].replace(/\+/g," ")),this.screenToRenderParam},h.trackEvent=function(a){return this.debug("trackEvent"),this.visible()?(e.trackJanrainOmnitureEvent(a),this):this},h.renderScreen=function(a){return this.debug("renderScreen"),janrain.capture.ui.renderScreen(a),this},h.endSession=function(){return this.debug("endSession"),janrain.capture.ui.hasActiveSession()&&(janrain.capture.ui.endCaptureSession(),localStorage.removeItem("janrainCaptureToken")),this},h.getCaptureToken=function(){return this.debug("getCaptureToken"),localStorage.janrainCaptureToken||""},h.showProfile=function(a){return this.debug("showProfile"),this.settingsPage&&this.profileHeader(a).renderScreen("editProfile").handlePlusButton().showSlatePlusEmail(),this},h.showRegistration=function(){return this.debug("showRegistration"),a(".sign-in-link, .sign-up-link").parent().show(),a("#mobile_username_display, .username-display").html("").hide(),mobileMode()&&a("#mobile_identity").show(),this},h.handleCaptureLinkAccountError=function(b){return a("#capture_editProfile_linkAccountContainer").append("      <p><strong>An error occurred:</strong> "+b.message+"<br>      <small>Provider: "+b.provider+"</small></p>    "),this},h.login=function(){if(this.debug("login"),!this.visible())return this;var a=this.storage.localStorage,b=(janrain.capture.ui.getReturnExperienceData("displayName"),janrain.capture.ui.getReturnExperienceData("uuid"));return a.set({wapo_login_id:b}),this.assignLoginID("wapo_login_id",0),this},h.getTokens=function(c){if(this.debug("getTokens"),!this.visible())return this;var e=this,f=e.storage.localStorage,g=janrain.capture.ui.getReturnExperienceData("displayName"),h=janrain.capture.ui.getReturnExperienceData("uuid"),i=["lf_secure_login_id","sp_secure_id"];return f.isEmpty(i)?this.myslateAjax=a.ajax({url:d.getMySlateURL(b.myslate.myslateTokenPath),method:"GET",data:{user_id:h,display_name:g,expires:localStorage.janrainCaptureToken_Expires,token:c.accessToken},dataType:"jsonp"}).done(function(a){janrain.capture.ui.hasActiveSession()&&(f.set(a),e.assignLoginID("sp_secure_id",0).handleLivefyre().handleUserAuthentication())}).fail(function(a,b){e.debug("\t",b)}):e.handleLivefyre().handleUserAuthentication(),this},h.renewJanrainToken=function(c){this.debug("renewJanrainToken"),c=c||0;var e=janrain.capture.ui.getReturnExperienceData("uuid"),f=this;return a.ajax({url:d.getMySlateURL(b.myslate.myslateJanrainTokenPath),method:"GET",data:{uuid:e,redirect_uri:window.location.href},dataType:"jsonp"}).done(function(a){if(!a.success)return void f.debug("\t",a);janrain.capture.ui.createCaptureSession(a.access_token),c&&setTimeout(function(){window.location.href=window.location.href},f.config.raceConditionTimeout)}).fail(function(a,b){f.debug("\t",b)}),this},h.setSlateProfileToken=function(){this.debug("setSlateProfileToken");var a=this.storage.localStorage,b=new Date,c=b.getTime();return c+=3e6,b.setTime(c),a.set("slateProfileToken",Date.parse(b)),this},h.handleSlateProfileToken=function(){this.debug("handleSlateProfileToken");var a=this.storage.localStorage,b=a.get("slateProfileToken");return Date.now()>b&&this.setSlateProfileToken().renewJanrainToken(0),this},h.moveLegalAcceptances=function(){this.debug("moveLegalAcceptances");var b=a("#legalAcceptances");return b.size()&&this.settingsPage&&a("#settings").append(b),this},h.handleLivefyre=function(){if(this.debug("handleLivefyre"),!this.visible()||"undefined"==typeof Livefyre)return this;var b=this.storage.localStorage;return Livefyre.require(["auth"],function(c){var d=b.get("lf_secure_login_id");if(d)return c.authenticate({livefyre:d}),a("#livefyre, #livechat").on("click",".fyre-edit-profile-link a",function(a){window.location.href=l}),this;c.logout()}),this},h.profileHeader=function(b){this.debug("profileHeader");var c="ACCOUNT SIGN IN AND REGISTRATION";return b&&(c='<span class="username">Hi '+b+'</span>              <em>Here\'s Your Slate Account!</em>              <a href="javascript: void(0)" onclick="janrain.capture.ui.endCaptureSession()" class="sign-out">Sign Out</a>'),a("#account_header").html(c),this},h.mobileProfileHeader=function(){this.debug("mobileProfileHeader");var b=this;return janrain.capture.ui.hasActiveSession()&&(a("#mobile_identity").hide(),a("#mobile_username_display").html('<span class="welcome link option"><a href="'+l+'" class="nav-option first" style="padding-right:10px;">Hi <span class="username">'+janrain.capture.ui.getReturnExperienceData("displayName")+'</span></a></span><span class="link option" style="padding-left:10px;"><a href="#" class="sign-out nav-option">SIGN OUT</a></span>').show(),a(".sign-out").click(function(){b.endSession(),a(".nav-panel .user-link").click(function(a){a.preventDefault()})})),this},h.redirectTo=function(b,c){return this.debug("redirectTo"),b=b||"/",c="undefined"!==a.type(c)?c:1,this.settingsPage&&(c&&this.endSession(),this.delay?setTimeout(function(){window.location.href=b},this.delay):window.location.href=b),this},h.showAccountDeactivated=function(){if(this.debug("showAccountDeactivated"),this.settingsPage){this.delay=1e3*5,a("#settings").html('        <div id="accountDeactivated--settings">          <div class="capture_header">            <h1>Deactivated Account</h1>          </div>          <div class="content_wrapper">            <p>Your account has been deactivated.</p>            <p>Trouble? Get help: <a href="mailto:plus@slate.com">plus@slate.com</a></p>          </div>        </div>      ')}return this},h.showUserMessage=function(b){this.debug("showUserMessage");var c=a("#"+b);return c.size()&&c.append(this.config.userMessage),this},h.deleteProfileData=function(){if(this.debug("deleteProfileData"),this.isSecure&&d.isSlatePlusUser)return this;var c=this.storage.localStorage;c.removeAll(!0),c=this.storage.sessionStorage,c.removeAll(!0),$cookies=["wapo_login_id","wapo_vis_id","sp_secure_id","slate_plus","lf_secure_login_id"];for(var e=$cookies.length,f=0;f<e;f++)"undefined"!==a.type(a.cookie($cookies[f]))&&a.removeCookie($cookies[f],{domain:b.myslate.site_base_domain,path:"/"});return d.removeAllCookies(),d.getMySlateUserData(),this},h.checkSecure=function(){this.debug("checkSecure");var a=["secure.slate.com","pub1.slate.com","pub2.slate.com","pub1w.slate.com","pub2w.slate.com","author.slate.com","iscroll-pub.slate.com"];return this.isSecure=a.indexOf(window.location.hostname)>-1,this},h.logout=function(){return this.debug("logout"),"undefined"==typeof Livefyre?this:(Livefyre.require(["auth"],function(a){a.hasDelegate()&&a.logout()}),this)},h.removeProfile=function(){return this.debug("removeProfile"),this.settingsPage&&this.renderScreen("signIn"),this},h.handlePasswordReset=function(){var b=this;return a(document).on("click","#resetPasswordRequestCodeSuccess a",function(){b.profileNavOpen()}),this};var n=0;h.profileNavOpen=function(){if(this.debug("profileNavOpen"),n)return this;n=1;var b=this;if(this.defaultScreens.indexOf(this.screenToRenderParam)>-1)return this.screenToRenderParam=null,this;if(this.settingsPage){var c=a("html").hasClass("touch")?"touchstart":"click";a(a(".global-nav-handle:visible").filter(function(b){return a(this).visible()}).get(0)).trigger(c),setTimeout(function(){a("#sign_in_link").click(),b.handlePlusUserLoggedout()},this.config.raceConditionTimeout)}return this},h.navClose=function(){return this.debug("navClose"),a(".nav-header").data("plugin_SGGlobalNav")&&a(".nav-header").data("plugin_SGGlobalNav").close(),mobileMode()&&a(".comments-container").hasClass("visible")&&(a("#mobile_identity_inline").remove(),setTimeout(function(){a(window).trigger("livefyre:initialRenderComplete",{})},1e3)),this},h.showUsername=function(b){this.debug("showUsername");var c=this;return c.mobileProfileHeader(),"undefined"===a.type(b)?this.showRegistration():(0===a(".username-display").size()&&a(".buttons").prepend('<span class="link option username-display" style="display:none;"></span>'),a(".sign-in-link, .sign-up-link").parent().hide(),a("#mobile_identity").hide(),a(".username-display").html('<span class="welcome link option"><a href="'+l+'" class="nav-option first">Hi <span class="username">'+b+'</span></a></span><span class="link option"><a href="#" class="sign-out nav-option">SIGN OUT</a></span>').show(),a(".nav-panel .user-link").click(function(){window.location=l}),a(".sign-out").on("click",function(a){return c.endSession(),!1})),this},h.assignLoginID=function(c,d){this.debug("assignLoginID",c,d),c=c||"wapo_login_id",d=d||0;var e=this.storage.localStorage,f=e.get(c);return"undefined"===a.type(a.cookie(c))&&f&&(a.cookie(c,f,{domain:b.myslate.site_base_domain,path:"/",expires:10950}),d&&(this.debug("calling myslate...again"),this.getMySlateUserData())),this},h.getMySlateUserData=function(){return this.debug("getMySlateData"),d.getMySlateUserData(),this},h.checkMySlateUserData=function(){return this.debug("checkMySlateUserData"),b.page.slateplus&&this.getMySlateUserData(),this},h.myslatePageRefresh=function(){return this.debug("myslatePageRefresh"),b.page.slateplus&&window.location.reload(),this};var o=0;return h.handleMySlateCall=function(c){if(o)return this;this.debug("handleMySlateCall",o),o=1,c=c||"s_session";var d=this.storage.sessionStorage;if(d.isEmpty(c)){var e={};a.cookie("s_vi")&&(e.s_vi=a.cookie("s_vi")),a.cookie("wapo_login_id")&&(e.wapo_login_id=a.cookie("wapo_login_id"));var f=b.myslate.myslate_domain,g=b.myslate.myslate_https,h=(g?"https:":"http:")+f+b.myslate.myslateSegmentsPath;a.ajax(h,{dataType:"jsonp",data:e,success:function(e){var f="none",g=new Date;if(g.setTime(g.getTime()+2592e6),!0===e.success){f="";for(var h=0,i=e.visitor.segments.length;h<i;h++)f+=e.visitor.segments[h],h<e.visitor.segments.length-1&&(f+=",")}a.cookie("s_segs",f,{domain:b.myslate.site_base_domain,expires:g,path:"/"}),d.set(c,!0)}})}},h.myslateSegments=function(){if(this.debug("myslateSegments"),!this.visible())return this;var a="s_session";return janrain.capture.ui.hasActiveSession()&&(a="s_session_loggedin"),this.handleMySlateCall(a),this},h.getMembershipStatus=function(){return this.debug("getMembershipStatus"),"undefined"!==a.type(d.membership)&&null!==d.membership?d.membership.membership_status_display||"":""},h.handleMySlateCommunication=function(a,c){this.debug("handleMySlateCommunication");var d=a.janrain,e={};switch(d.type){case"ready":e[d.type]=janrain.ready&&b.janrain.siteConfig.ready;break;case"hasActiveSession":e[d.type]=janrain.capture.ui.hasActiveSession();break;case"getReturnExperienceData":e[d.type]=janrain.capture.ui.getReturnExperienceData(d.param)}c.postMessage(e,"*")},h.showSlatePlus=function(){return this.debug("showSlatePlus"),d.isSlatePlusUser?this:((b.page.roadblocked||b.page.pitchPage||d.isCustomRoadblock)&&c.showFormInFrame("roadblock_form",janrain.capture.ui.hasActiveSession()),this)},h.handleSlatePlusDeactivationWarning=function(){return this.debug("handleSlatePlusDeactivationWarning"),d.isSlatePlusUser&&a("#confirmAccountDeactivation .content_wrapper form").before('        <p class="member-warning"><strong>SLATE PLUS MEMBER WARNING:</strong>        Deactivating your Slate.com account will prevent you from accessing Slate Plus content.        It will NOT cancel your Slate Plus membership.        Any recurring payments will continue.        To cancel your membership, <a href="/account.plususer.html">visit your Slate Plus account page</a>.</p>      '),this},h.showSlatePlusEmail=function(){return this.debug("showSlatePlusEmail"),$email=a(['#capture_editProfile_form_item_subscriptionList input[data-subid="Plus"]','#capture_editProfile_form_item_subscriptionList input[data-subid="S+ Prudie Early Release"]','#capture_editProfile_form_item_subscriptionList input[data-subid="S+ Recommended for You (Horizon Feed)"]','#capture_editProfile_form_item_subscriptionList input[data-subid="S+ What We Like Right Now"]','#capture_editProfile_form_item_subscriptionList input[data-subid="S+ Reading List"]'].join(",")).parent(),this.settingsPage&&d.isSlatePlusUser?($email.show(),a(".slateplus-account").addClass("slateplus-account--visible")):$email.hide(),this},h.handlePlusUserLoggedout=function(){return document.referrer.indexOf(".plususer.")>-1&&this.settingsPage&&a("#nav_registration_content").prepend(['<p class="secure-info">',"Plus members, please sign in again to access your account information securely.","</p>"].join("")),this},h.handleUserAuthentication=function(){if(this.debug("handleUserAuthentication"),!this.settingsPage)return this;var c=this,e="",g=window.location.pathname.split(".");if(g.length>2&&(e=g[1]),"plususer"==e&&(d.isSlatePlusUser||this.myslateStatuses.indexOf(this.getMembershipStatus())>-1)){var h=this.storage.localStorage,j=h.get("sp_secure_id"),k=h.get("wapo_login_id");a.ajax({url:d.getMySlateURL()+b.myslate.myslateVerifyPath,dataType:"jsonp",data:{uuid:k,sp_secure_id:j}}).done(function(e){if(e.valid){a("#settings").html(f["account.identity"]({url:d.getMySlateURL()+b.myslate.myslateSubscriptionsManagePath}));var g=function c(d){if(d.originalEvent.origin.indexOf(b.myslate.site_base_domain)>-1){var e=JSON.parse(d.originalEvent.data);a("#myslate-manage-subscriptions").height(e.accountHeight),i.off("message",c)}};i.on("message",g)}else c.redirectTo(window.location.href.replace(".plususer.",".settings."))}).fail(function(a,b){c.debug(b),c.redirectTo(window.location.href.replace(".plususer.",".settings."))})}return this},h.checkWrongPage=function(){this.debug("checkWrongPage");var a="",b=window.location.pathname.split(".");return b.length>2&&(a=b[1]),"plususer"!==a||d.isSlatePlusUser||-1!==this.myslateStatuses.indexOf(this.getMembershipStatus())||this.redirectTo(window.location.href.replace(".plususer.",".settings."),0),this},h.handlePlusButton=function(){return this.debug("handlePlusButton"),(d.isSlatePlusUser||this.myslateStatuses.indexOf(this.getMembershipStatus())>-1)&&a("#plususer_button").show(),this},h.hideRoadblock=function(){return this.debug("hideRoadblock"),this.hasRoadblock&&c.hideRoadblock(),this},h.handlePlusHomepagePromo=function(){if(this.debug("handlePlusHomepagePromo"),!this.isHomePage)return this;var b="slateplus-promo__upsell--visible";return d.isSlatePlusUser&&(a(".slateplus-promo__title").addClass("slateplus-promo__title--full-width"),b="slateplus-promo__upsell--hidden"),a(".slateplus-promo__upsell").addClass(b),this},h.removePlusHomepagePromo=function(){return this.debug("removePlusHomepagePromo"),this.isHomePage?(a(".slateplus-promo__title").removeClass("slateplus-promo__title--full-width"),a(".slateplus-promo__upsell").removeClass("slateplus-promo__upsell--hidden").addClass("slateplus-promo__upsell--visible"),this):this},h.addFBEvents=function(){return this.debug("addFBEvents"),g("track","PageView"),g("track","CompleteRegistration"),this},h.beginDebug=function(a){return this.debugEnabled&&console.group(a.split(":").join("\n\t")),this},h.debug=function(a){this.debugEnabled&&console.log.apply(console,arguments)},h.endDebug=function(){return this.debugEnabled&&console.groupEnd(),this},h.init()});